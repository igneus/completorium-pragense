\documentclass[a5paper, 12pt]{book}
\usepackage[latin]{babel}
\usepackage[left=2cm, right=2cm, top=2cm, bottom=2cm]{geometry}

\usepackage{fontspec}
\usepackage[hidelinks]{hyperref}
\usepackage{etoolbox}
\usepackage[show]{ed}

% for gregorio
\usepackage{luatextra}
\usepackage{graphicx}
\usepackage{gregoriotex}

\usepackage[
  backend=biber,
  style=iso-authoryear,
  sortlocale=cs_CZ,
  maxnames=3,
  firstinits=true,
]{biblatex}

\bibliography{biblio}

% rubric
\newcommand{\rubrica}[1]{\textit{#1}}

% text incipit inside a rubric
\newcommand{\incipit}[1]{\textup{#1}}

% insert full text of a hymn
\newcommand{\hymnus}[1]{%
  \phantomsection
  \label{hym:#1}
  \input{hymni/#1}}

% insert chant notation
\newcommand{\cantus}[1]{%
  \phantomsection
  \label{can:#1}
  \input{cantus/#1.gtex}}

% inline page reference to full text or notation elsewhere
\newcommand{\quickref}[1]{\quickrefFormat{\pageref{#1}}}
\newcommand{\missingref}{\quickrefFormat{?}}
\newcommand{\quickrefFormat}[1]{\textsuperscript{\textup{(#1)}}}

% text not literally reproducing the source,
% but supplemented by the editor
\newcommand{\editorial}[1]{[#1]}





\title{Completorium secundum Rubricam pragensem}

\begin{document}

\maketitle

\chapter{Psalmi}
\label{psalmi}

\chapter{Hymnarius}

\hymnus{conditor}

\chapter{Preces}
\label{preces}

\edissue{So far I haven't found the Compline preces in the printed breviary, but they are in XIV A 19, 1v (full text with the Advent versicle already inserted)}

\chapter{In Adventu Domini}

\rubrica{Hymnus \incipit{Conditor alme siderum}\quickref{hym:conditor}
  in completorio
  nunquam mutatur, nisi in Conceptione sanctae Mariae.}\footcite[83r]{bp1502}
\vspace{3mm}

\rubrica{Ad completorium psalmi consueti,\quickref{psalmi}
  quos sequitur \incipit{alleluia.}}
\edissue{Not sure what exactly the alleluia means. An antiphon super psalmos? But XIV A 19 doesn't notate it.}

\rubrica{Capitulum}
Patientes estote et confirmate corda vestra:
quoniam adventus Domini appropinquabit.
Deo \editorial{gratias}.

\rubrica{Hymnus}
Conditor alme.\quickref{hym:conditor}

\rubrica{V.}
Emitte agnum Domine, dominatorem terrae.
De petra deserti ad montem filiae Sion.

\rubrica{Ad Nunc dimittis antiphona}
Qui venturus est veniet et non tardabit. Iam non erit timor in finibus nostris.\quickref{can:adventus_quiventurus}

\rubrica{Preces solitae\quickref{preces}
  dicuntur versum adiungendo de Adventu, scilicet istum.}
Veni Domine et noli tardare. Relaxa facinora plebis tuae.

\rubrica{Oratio}
Fac nos quaesumus Domine Deus noster pervigiles atque solicitos adventum
Christi Filii tui exspectare: ut dum venerit pulsans,
non dormientes in peccatis, sed vigilantes in suis laudibus inveniat
exsultantes. Qui tecum.

\rubrica{Alia oratio}
Prope esto Domine omnibus exspectantibus te in veritate:
ut in adventu Domini nostri Iesu Christi placitis tibi actibus praesentemur.
Qui tecum.

\rubrica{Una istarum orationum dicatur quae placet et non plus.
  Hic ordo completorii non mutatur per totum Adventum
  nisi in Conceptione sanctae Mariae.}\footcite[83r-83v]{bp1502}

\section*{Cantus}

\cantus{adventus_quiventurus}

\printbibliography

\end{document}
